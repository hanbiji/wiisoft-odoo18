<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_mall_contract_tree" model="ir.ui.view">
        <field name="name">mall.leasing.contract.list</field>
        <field name="model">mall.leasing.contract</field>
        <field name="arch" type="xml">
            <list>
                <field name="name"/>
                <field name="mall_id"/>
                <field name="contract_type"/>
                <field name="shop_name"/>
                <field name="facade_ids" widget="many2many_tags"/>
                <field name="partner_id"/>
                <field name="operator_id"/>
                <field name="property_company_id"/>
                <field name="state"/>
                <field name="lease_start_date"/>
                <field name="lease_end_date"/>
                <field name="payment_frequency"/>
                <field name="deposit" column_invisible="context.get('default_contract_type') == 'property'"/>
                <field name="rent_amount" column_invisible="context.get('default_contract_type') == 'property'"/>
                <field name="property_fee" column_invisible="context.get('default_contract_type') == 'tenant'"/>
                <field name="service_fee" column_invisible="context.get('default_contract_type') == 'tenant'"/>
                <field name="next_bill_date"/>
            </list>
        </field>
    </record>

    <record id="view_mall_contract_form" model="ir.ui.view">
        <field name="name">mall.leasing.contract.form</field>
        <field name="model">mall.leasing.contract</field>
        <field name="arch" type="xml">
            <form string="租赁合同">
                <header>
                    <button name="action_reject" type="object" string="审核拒绝" invisible="state != 'draft'"/>
                    <button name="action_approve" type="object" string="审核通过" class="oe_highlight" invisible="state != 'draft'"/>
                    <button name="action_sign" type="object" string="签约" class="oe_highlight" invisible="state != 'approved'"/>
                    
                    <!-- 新增：创建物业合同按钮 -->
                    <button name="action_create_property_contract" 
                        type="object" 
                        string="创建物业合同" 
                        class="btn" 
                        invisible="contract_type == 'property'"/>
                    
                    <button name="action_generate_move" type="object" string="生成账单" class="oe_highlight" invisible="state != 'active'"/>
                    <button name="action_view_invoices" type="object" string="查看发票" class="btn-secondary" invisible="invoice_count == 0"/>
                    <button name="action_active" type="object" string="激活合同" class="oe_highlight" invisible="state != 'signed'"/>

                    <field name="state" widget="statusbar" statusbar_visible="draft,approved,signed,active,renewed,terminated"/>
                </header>
                
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_invoices" type="object" class="oe_stat_button" icon="fa-file-text-o" invisible="invoice_count == 0">
                            <field name="invoice_count" widget="statinfo" string="发票"/>
                        </button>
                        <button name="action_view_property_contracts" 
                            string="物业合同"
                            type="object" 
                            class="oe_stat_button" 
                            icon="fa-building" 
                            invisible="contract_type == 'property'"/>
                        <button name="action_view_tenant_contracts" 
                            string="租赁合同"
                            type="object" 
                            class="oe_stat_button" 
                            icon="fa-user" 
                            invisible="contract_type == 'tenant'"/>
                    </div>
                    <group>
                        <group>
                            <field name="name" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="contract_type" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="mall_id" options="{'no_create': True}" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="facade_ids" domain="[('mall_id', '=', mall_id), ('status', '=', 'vacant')]" widget="many2many_tags" options="{'no_create': True}" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="operator_id" 
                                invisible="contract_type == 'property'"
                                options="{'no_create': True}" 
                                readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="property_company_id" 
                                invisible="contract_type == 'tenant'"
                                options="{'no_create': True}" 
                                readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="partner_id" options="{'no_create': True}" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="shop_name" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="currency_id" readonly="1" options="{'no_create': True, 'no_open': True}"/>
                            <field name="bank_account" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                        </group>
                        <group>
                            <field name="lease_term" readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                            <field name="lease_start_date"/>
                            <field name="lease_end_date"/>
                            <field name="free_rent_from"/>
                            <field name="free_rent_to"/>
                            <field name="escalation_rate"/>
                            <field name="payment_frequency"/>
                            <field name="payment_day"/>
                            <field name="next_bill_date" readonly="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="费用">
                            <group>
                                <field name="rent_amount" invisible="contract_type == 'property'"/>
                                <field name="deposit" invisible="contract_type == 'property'"/>
                                <field name="property_fee" invisible="contract_type == 'tenant'"/>
                                <field name="service_fee" invisible="contract_type == 'tenant'"/>
                            </group>
                        </page>
                        
                        <page string="介绍人/中介" invisible="contract_type == 'property'">
                            <group>
                                <field name="introducer_id" options="{'no_create': True, 'no_open': True}" domain="[('mall_contact_type', '=', 'intermediary')]"
                                    readonly="state in ['approved', 'signed', 'active', 'renewed', 'terminated']"/>
                                <field name="commission_type"/>
                                <field name="commission_amount"/>
                                <field name="commission_paid"/>
                            </group>
                        </page>
                        <page string="相关发票">
                            <field name="invoice_ids" readonly="1">
                                <list>
                                    <field name="name" string="发票号"/>
                                    <field name="ref"/>
                                    <field name="invoice_date" width="120"/>
                                    <field name="invoice_date_due" width="120"/>
                                    <field name="amount_total" sum="Total"/>
                                    <field name="amount_residual" string="欠款金额" sum="Residual"/>
                                    <field name="payment_state" 
                                        decoration-success="payment_state == 'paid'" 
                                        decoration-warning="payment_state in ('partial', 'in_payment')" 
                                        decoration-danger="payment_state in ('not_paid', 'blocked')" 
                                        decoration-muted="payment_state in ('reversed', 'invoicing_legacy')"
                                        widget="badge"/>
                                    <field name="state"/>
                                    <field name="currency_id" column_invisible="1"/>
                                </list>
                            </field>
                        </page>
                        
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <chatter/>
                </div>
            </form>
        </field>
    </record>

    <record id="act_mall_contract" model="ir.actions.act_window">
        <field name="name">合同</field>
        <field name="res_model">mall.leasing.contract</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- 租户合同动作 -->
    <record id="action_tenant_contracts" model="ir.actions.act_window">
        <field name="name">租赁合同</field>
        <field name="res_model">mall.leasing.contract</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('contract_type', '=', 'tenant')]</field>
        <field name="context">{'default_contract_type': 'tenant'}</field>
    </record>
    <!-- 物业合同动作 -->
    <record id="action_property_contracts" model="ir.actions.act_window">
        <field name="name">物业合同</field>
        <field name="res_model">mall.leasing.contract</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('contract_type', '=', 'property')]</field>
        <field name="context">{'default_contract_type': 'property'}</field>
    </record>

    <!-- 房东合同动作 -->
    <record id="action_landlord_contracts" model="ir.actions.act_window">
        <field name="name">房东合同</field>
        <field name="res_model">mall.leasing.contract</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('contract_type', '=', 'landlord')]</field>
        <field name="context">{'default_contract_type': 'landlord'}</field>
    </record>
</odoo>